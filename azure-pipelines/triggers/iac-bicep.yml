name: 'IaC-Trigger'

variables:
  - name: resourceGroupName
    value: 'azure-pipelines-with-github-repo'
  - name: location
    value: 'westeurope'
  - name: azureSubscription
    value: 'ARM-mauwii'
  - name: isMain
    value: $[ eq(variables['Build.SourceBranch'], 'refs/heads/main') ]
    readonly: true
  - name: isStable
    value: $[ eq(variables['Build.SourceBranch'], 'refs/heads/stable') ]
    readonly: true
  - name: isPullRequest
    value: $[ eq(variables['Build.Reason'], 'PullRequest') ]
    readonly: true
  - name: sourceBranchName
    value: $[ variables['Build.SourceBranchName'] ]
  - template: azure-pipelines/variables/default.yml

trigger:
  branches:
    include:
      - feature/*
  # paths:
  #   include:
  #     - IaC/bicep

pool:
  vmImage: ubuntu-latest

parameters:
  - name: bicepDir
    type: string
    default: IaC/bicep/deploy

steps:
  - powershell: |
      $folderNames = ( Get-ChildItem ${{ parameters.bicepDir }} ).Name
      Write-Host "##vso[task.setvariable variable=templateFolders;]$folderNames"

  - ${{ each value in variables.templateFolders }}:
      - template: ../jobs/bicep_jobs.yml
        parameters:
          bicepDir: ${{ parameters.bicepDir }}
          bicepTemplateDir: ${{ value }}
          bicepParameter: ${{ parameters.bicepParameter }}
